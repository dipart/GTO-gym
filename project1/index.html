<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTO Trainer & Manager v3.0 - æ‰‘å…‹åšå¼ˆè®ºè®­ç»ƒå™¨</title>
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ (ä¿æŒæš—é»‘ç²¾è‹±é£) --- */
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
            display: flex; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar { 
            width: 300px; 
            background-color: #1e1e1e; 
            padding: 15px; 
            border-right: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            overflow-y: auto; 
            z-index: 10; 
        }
        
        .main { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            position: relative; 
            background-color: #000; 
        }
        
        h2 { 
            color: #fff; 
            font-size: 16px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 8px; 
            margin: 0 0 10px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .group-title { 
            font-size: 11px; 
            color: #4fc3f7; 
            font-weight: bold; 
            margin-top: 5px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        select { 
            width: 100%; 
            padding: 8px; 
            background: #2c2c2c; 
            border: 1px solid #444; 
            color: #fff; 
            border-radius: 4px; 
            outline: none; 
            font-size: 13px; 
        }
        
        select:focus { 
            border-color: #4fc3f7; 
        }

        /* æŒ‰é’®ä½“ç³» */
        .btn { 
            padding: 8px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.2s; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
        }
        
        .btn-primary { 
            background-color: #0d47a1; 
            color: white; 
            width: 100%; 
            margin-top: 5px; 
        }
        
        .btn-primary:hover { 
            background-color: #1565c0; 
        }
        
        .btn-danger { 
            background-color: #c62828; 
            color: white; 
        }
        
        .btn-icon { 
            background: transparent; 
            color: #888; 
            border: 1px solid #444; 
            width: auto; 
            flex: 1; 
        }
        
        .btn-icon:hover { 
            background: #333; 
            color: #fff; 
        }

        /* GTO å¯¹æ¯”å¼€å…³ */
        .toggle-container { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: #2c2c2c; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #444; 
            margin-top: 15px; 
        }
        
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 40px; 
            height: 20px; 
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #555; 
            transition: .4s; 
            border-radius: 20px; 
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 16px; 
            width: 16px; 
            left: 2px; 
            bottom: 2px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        
        input:checked + .slider { 
            background-color: #4caf50; 
        }
        
        input:checked + .slider:before { 
            transform: translateX(20px); 
        }

        /* æ¡£æ¡ˆåº“å¼¹çª— */
        .library-panel {
            position: fixed; 
            top: 0; 
            right: -350px; 
            width: 300px; 
            height: 100%; 
            background: #1e1e1e; 
            border-left: 1px solid #444; 
            transition: 0.3s; 
            z-index: 100; 
            padding: 20px; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            display: flex; 
            flex-direction: column;
        }
        
        .library-panel.open { 
            right: 0; 
        }
        
        .record-item { 
            background: #2c2c2c; 
            padding: 10px; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            font-size: 12px; 
            border-left: 3px solid #4fc3f7; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .record-item:hover { 
            background: #333; 
        }
        
        .record-info { 
            display: flex; 
            flex-direction: column; 
        }
        
        .record-date { 
            color: #666; 
            font-size: 10px; 
            margin-top: 2px; 
        }

        /* 13x13 ç½‘æ ¼ç³»ç»Ÿ */
        .grid-container {
            display: grid; 
            grid-template-columns: repeat(13, 1fr); 
            gap: 2px; 
            background-color: #000; 
            padding: 5px; 
            border-radius: 4px;
            width: 90vh; 
            height: 90vh; 
            max-width: 650px; 
            max-height: 650px; 
            margin-bottom: 10px; 
            position: relative;
        }

        .cell {
            background-color: #2a2a2a; 
            color: #666; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 12px; 
            cursor: pointer; 
            user-select: none; 
            border-radius: 2px; 
            position: relative;
        }
        
        .cell:hover { 
            background-color: #444; 
        }
        
        .pair { 
            color: #eee; 
            font-weight: bold; 
        } /* å¯¹å­æ›´äº® */

        /* çŠ¶æ€é¢œè‰² */
        .cell.raise { 
            background-color: #d32f2f; 
            color: #fff; 
            font-weight: bold; 
        }
        
        .cell.call { 
            background-color: #388e3c; 
            color: #fff; 
            font-weight: bold; 
        }
        
        .cell.mix { 
            background-color: #fbc02d; 
            color: #000; 
            font-weight: bold; 
        }
        
        .cell.fold { 
            background-color: #2a2a2a; 
        }

        /* --- GTO å¯¹æ¯”å›¾å±‚æ ·å¼ --- */
        /* 1. æ¼é€‰ (GTOæ˜¯è¦æ‰“ï¼Œä½ æ²¡æ‰“): è™šçº¿æ¡† + æç¤ºç‚¹ */
        .cell.gto-miss::after {
            content: ''; 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            width: 6px; 
            height: 6px; 
            background: #00e676; 
            border-radius: 50%; 
            box-shadow: 0 0 5px #00e676;
        }
        
        .cell.gto-miss { 
            border: 1px dashed #00e676; 
            opacity: 0.8; 
        }

        /* 2. å¤šé€‰ (GTOæ˜¯å¼ƒç‰Œï¼Œä½ æ‰“äº†): çº¢è‰²å‰å‰ */
        .cell.gto-wrong::after {
            content: 'Ã—'; 
            position: absolute; 
            font-size: 16px; 
            color: #fff; 
            font-weight: bold; 
            top: -2px; 
            right: 2px; 
            text-shadow: 0 0 3px #000;
        }
        
        /* 3. æ­£ç¡® (å»åˆ): ç»¿è‰²å°å‹¾ */
        .cell.gto-match::after {
            content: 'âœ“'; 
            position: absolute; 
            font-size: 10px; 
            color: rgba(255,255,255,0.7); 
            bottom: 1px; 
            right: 2px;
        }

        .legend { 
            display: flex; 
            gap: 15px; 
            font-size: 12px; 
            color: #aaa; 
        }
        
        .dot { 
            width: 10px; 
            height: 10px; 
            margin-right: 5px; 
            border-radius: 2px; 
            display: inline-block; 
        }

        /* æ¶ˆæ¯æç¤º */
        #msgBox { 
            position: absolute; 
            bottom: 20px; 
            background: rgba(0,0,0,0.8); 
            color: #fff; 
            padding: 10px 20px; 
            border-radius: 20px; 
            font-size: 13px; 
            opacity: 0; 
            transition: 0.3s; 
            pointer-events: none; 
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .main {
                padding: 20px;
            }
            
            .grid-container {
                width: 80vw;
                height: 80vw;
                max-width: 500px;
                max-height: 500px;
            }
            
            .library-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ ï¼šæ§åˆ¶å™¨ -->
    <div class="sidebar">
        <h2>ğŸ® æ§åˆ¶å° <span style="font-size:10px; color:#666">v3.0</span></h2>
        
        <div class="group-title">1. æ¨¡å¼ & äººæ•°</div>
        <div style="display:flex; gap:5px">
            <select id="modeSelect" onchange="updateOptions()">
                <option value="MTT">ğŸ† MTT é”¦æ ‡èµ›</option>
                <option value="Cash">ğŸ’° ç°é‡‘å±€</option>
            </select>
            <select id="tableSizeSelect" onchange="updateOptions()">
                <option value="9-Max">9äºº</option>
                <option value="8-Max" selected>8äºº</option>
                <option value="6-Max">6äºº</option>
                <option value="HU">å•æŒ‘</option>
            </select>
        </div>

        <div class="group-title">2. ä½ç½® & æ·±åº¦</div>
        <div style="display:flex; gap:5px">
            <select id="positionSelect" onchange="resetAndCheckGTO()"></select>
            <select id="stackSelect" onchange="resetAndCheckGTO()"></select>
        </div>

        <div class="group-title">3. åŠ¨ä½œç±»å‹</div>
        <select id="actionSelect">
            <option value="RFI">ç‡å…ˆåŠ æ³¨ (Open)</option>
            <option value="vs_3bet">é¢å¯¹ 3-Bet</option>
            <option value="Blind_Def">ç›²æ³¨é˜²å®ˆ</option>
        </select>

        <!-- GTO æ ¸å¿ƒåŠŸèƒ½åŒº -->
        <div class="toggle-container">
            <div>
                <div style="font-weight:bold; font-size:13px; color:#fff">GTO æ ‡å‡†ç­”æ¡ˆ</div>
                <div style="font-size:10px; color:#888">å åŠ ç®—æ³•å»ºè®®èŒƒå›´</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="gtoToggle" onchange="renderGrid()">
                <span class="slider"></span>
            </label>
        </div>

        <div style="flex:1"></div>

        <!-- æ‰‹ç‰ŒèŒƒå›´ç™¾åˆ†æ¯”æ˜¾ç¤º -->
        <div style="background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); padding: 15px; border-radius: 8px; border: 1px solid #4fc3f7; margin: 15px 0; text-align: center; box-shadow: 0 2px 10px rgba(79, 195, 247, 0.1);">
            <div style="font-size: 11px; color: #4fc3f7; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">æ‰‹ç‰ŒèŒƒå›´ç»Ÿè®¡</div>
            <div id="rangePercentage" style="font-size: 24px; font-weight: bold; color: #4fc3f7; text-shadow: 0 0 5px rgba(79, 195, 247, 0.3); margin: 5px 0;">0.0%</div>
            <div style="font-size: 10px; color: #888; margin-top: 5px;">å·²é€‰æ‰‹ç‰Œ: <span id="selectedHandsCount">0</span> / 169</div>
            <div style="width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 8px; overflow: hidden;">
                <div id="rangeProgressBar" style="height: 100%; background: linear-gradient(90deg, #4fc3f7, #29b6f6); width: 0%; transition: width 0.3s ease;"></div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="saveCurrent()">ğŸ’¾ ä¿å­˜å½“å‰èŒƒå›´</button>
        
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-icon" onclick="toggleLibrary()">ğŸ“‚ æ‰“å¼€æ¡£æ¡ˆåº“</button>
            <button class="btn btn-icon" onclick="clearGrid()" style="color:#d32f2f">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-icon" onclick="exportData()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
            <button class="btn btn-icon" onclick="importData()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
        </div>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main">
        <div class="grid-container" id="pokerGrid"></div>
        
        <div class="legend">
            <div><span class="dot" style="background:#d32f2f"></span>Raise</div>
            <div><span class="dot" style="background:#388e3c"></span>Call</div>
            <div><span class="dot" style="background:#fbc02d"></span>Mix</div>
            <div style="margin-left:15px"><span class="dot" style="border:1px dashed #00e676; background:transparent"></span>GTOå»ºè®®</div>
        </div>

        <div id="msgBox"></div>
    </div>

    <!-- æ¡£æ¡ˆåº“ä¾§æ»‘æ  -->
    <div class="library-panel" id="libraryPanel">
        <h2>ğŸ“‚ å·²å­˜æ¡£æ¡ˆ <button onclick="toggleLibrary()" style="background:none;border:none;color:#fff;cursor:pointer">Ã—</button></h2>
        <div id="recordList" style="flex:1; overflow-y:auto; margin-top:10px">
            <!-- è®°å½•åˆ—è¡¨ -->
        </div>
        <button class="btn btn-danger" onclick="clearAllData()" style="margin-top:10px">âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>

    <script>
        // === GTO ç®—æ³•æ ¸å¿ƒ (æ¨¡æ‹Ÿæ ‡å‡†ç­”æ¡ˆ) ===
        // ä¸ºäº†ä¸ä¾èµ–åºå¤§çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬ä½¿ç”¨ "Hand Ranking" ç®—æ³•æ¥åŠ¨æ€ç”Ÿæˆ RFI èŒƒå›´
        // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ GTO é€»è¾‘ï¼Œè¶³å¤Ÿç”¨äºæ—¥å¸¸è®­ç»ƒå‚è€ƒ
        
        // 169æ‰‹ç‰Œçš„å¼ºåº¦æ’åº (ç®€åŒ–çš„ Sklansky-Chubukov é€»è¾‘é¡ºåº)
        const handRankings = [
            "AA","KK","QQ","JJ","AKs","TT","AKo","AQs","99","AJs","KQs","ATs","AQo","88","KJs","QJs","AJo","KTs","QTs","JTs","77","A9s","K9s","Q9s","J9s","T9s","ATo","A8s","KTo","QJo","K8s","Q8s","J8s","T8s","98s","66","A7s","A5s","KJo","A4s","K7s","QTo","K6s","A6s","A3s","Q7s","JTo","J7s","T7s","97s","87s","A2s","K5s","55","Q6s","K4s","J6s","T6s","96s","86s","76s","A9o","K9o","Q9o","J9o","K3s","K2s","Q5s","T9o","J5s","T5s","95s","85s","75s","65s","44","Q4s","Q3s","Q2s","J4s","T4s","94s","84s","74s","64s","54s","A8o","K8o","Q8o","J8o","T8o","98o","33","22","A7o","A5o","A4o","J3s","J2s","T3s","T2s","93s","92s","83s","82s","73s","72s","63s","62s","53s","52s","43s","42s","32s"
            // æ³¨ï¼šæ­¤å¤„çœç•¥äº†éƒ¨åˆ†æå¼±ç‰Œçš„æ’åºä»¥èŠ‚çœç©ºé—´ï¼Œç®—æ³•ä¼šè‡ªåŠ¨è¡¥å…¨
        ];

        // ä¸åŒä½ç½®çš„ RFI (Open) é¢‘ç‡åŸºå‡† (8-Max ä¸ºä¾‹)
        const rfiFrequencies = {
            'UTG': 0.15, 'UTG+1': 0.18, 'LJ': 0.22, 'HJ': 0.28, 'CO': 0.35, 'BTN': 0.55, 'SB': 0.45, 'BB': 0
        };

        // ç”Ÿæˆ GTO èŒƒå›´
        function generateGTORange(pos, stack) {
            // ç®€å•ç®—æ³•ï¼šæ ¹æ®ä½ç½®ç™¾åˆ†æ¯”ï¼Œå– HandRanking å‰ X% çš„ç‰Œ
            let freq = rfiFrequencies[pos] || 0.15; // é»˜è®¤ 15%
            
            // ç­¹ç è°ƒæ•´ï¼šçŸ­ç­¹ç (MTT < 20BB) èŒƒå›´ä¼šå˜å®½ (Push/Fold)
            let stackVal = parseInt(stack);
            if (stack.includes('BB') && stackVal < 20) {
                freq *= 1.2; // èŒƒå›´åŠ å®½ 20%
            }

            const count = Math.floor(169 * freq);
            const range = new Set();
            
            // å–å‰ count æ‰‹å¼ºç‰Œ
            for(let i=0; i<count; i++) {
                if(handRankings[i]) range.add(handRankings[i]);
            }
            
            // è¡¥å……ç¡¬é€»è¾‘ï¼šAA-88, AK-AT æ°¸è¿œåœ¨èŒƒå›´é‡Œ
            ['AA','KK','QQ','JJ','TT','99','88','AKs','AQs','AJs','ATs','AKo','AQo','AJo'].forEach(h => range.add(h));
            
            return range;
        }

        // === åº”ç”¨é€»è¾‘ ===

        const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
        let userGridData = {}; // ç”¨æˆ·å½“å‰è¾“å…¥
        
        const config = {
            positions: {
                '9-Max': ['UTG', 'UTG+1', 'UTG+2', 'LJ', 'HJ', 'CO', 'BTN', 'SB'],
                '8-Max': ['UTG', 'UTG+1', 'LJ', 'HJ', 'CO', 'BTN', 'SB'],
                '6-Max': ['LJ', 'HJ', 'CO', 'BTN', 'SB'],
                'HU': ['SB']
            },
            stacks: {
                'MTT': ['10BB','15BB','20BB','25BB','30BB','40BB','50BB','60BB','100BB'],
                'Cash': ['100BB','200BB']
            }
        };

        function init() {
            createGrid();
            updateOptions();
            loadSavedList();
            updateRangePercentage(); // åˆå§‹åŒ–æ—¶æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
        }

        function updateOptions() {
            const size = document.getElementById('tableSizeSelect').value;
            const mode = document.getElementById('modeSelect').value;
            
            const posSel = document.getElementById('positionSelect');
            posSel.innerHTML = '';
            config.positions[size].forEach(p => posSel.add(new Option(p, p)));

            const stackSel = document.getElementById('stackSelect');
            stackSel.innerHTML = '';
            config.stacks[mode].forEach(s => stackSel.add(new Option(s, s)));
            
            renderGrid();
        }

        function createGrid() {
            const grid = document.getElementById('pokerGrid');
            grid.innerHTML = '';
            for(let i=0; i<13; i++) {
                for(let j=0; j<13; j++) {
                    const cell = document.createElement('div');
                    let hand = i===j ? ranks[i]+ranks[j] : (i<j ? ranks[i]+ranks[j]+'s' : ranks[j]+ranks[i]+'o');
                    let type = i===j ? 'pair' : (i<j ? 'suited' : 'offsuit');
                    
                    cell.className = 'cell fold';
                    if(type === 'pair') cell.classList.add('pair');
                    cell.innerText = hand;
                    cell.dataset.hand = hand;
                    cell.onclick = () => toggleCell(hand);
                    grid.appendChild(cell);
                }
            }
        }

        function toggleCell(hand) {
            // å¦‚æœå¼€å¯äº†GTOå¯¹æ¯”ï¼Œç‚¹å‡»æ˜¯ä¸ºäº†"é»˜å†™"ï¼Œä¾ç„¶å…è®¸åˆ‡æ¢é¢œè‰²
            const states = ['fold', 'raise', 'call', 'mix'];
            const current = userGridData[hand] || 'fold';
            const next = states[(states.indexOf(current)+1) % states.length];
            userGridData[hand] = next;
            renderGrid();
            updateRangePercentage(); // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
        }

        function resetAndCheckGTO() {
            // åˆ‡æ¢åœºæ™¯æ—¶ï¼Œæ¸…ç©ºç”¨æˆ·è¾“å…¥
            userGridData = {};
            renderGrid();
            updateRangePercentage(); // é‡ç½®æ—¶æ›´æ–°ç™¾åˆ†æ¯”
        }

        function renderGrid() {
            const showGTO = document.getElementById('gtoToggle').checked;
            const pos = document.getElementById('positionSelect').value;
            const stack = document.getElementById('stackSelect').value;
            
            // è·å–ç®—æ³•ç”Ÿæˆçš„ GTO èŒƒå›´ (ä»…é’ˆå¯¹ RFI åŠ¨ä½œï¼Œå…¶ä»–åŠ¨ä½œæš‚ä¸ç”Ÿæˆé¿å…è¯¯å¯¼)
            const action = document.getElementById('actionSelect').value;
            let gtoSet = new Set();
            if (showGTO && action === 'RFI') {
                gtoSet = generateGTORange(pos, stack);
            }

            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => {
                const hand = c.dataset.hand;
                const userStatus = userGridData[hand] || 'fold';
                
                // 1. æ¸²æŸ“ç”¨æˆ·çŠ¶æ€
                c.className = `cell ${userStatus}`;
                if (hand[0] === hand[1]) c.classList.add('pair'); // ä¿æŒå¯¹å­é«˜äº®

                // 2. æ¸²æŸ“ GTO å¯¹æ¯”é€»è¾‘
                if (showGTO && action === 'RFI') {
                    const isGTO = gtoSet.has(hand);
                    const isUserAction = userStatus !== 'fold';

                    if (isGTO && !isUserAction) {
                        c.classList.add('gto-miss'); // æ¼é€‰
                    } else if (!isGTO && isUserAction) {
                        c.classList.add('gto-wrong'); // å¤šé€‰
                    } else if (isGTO && isUserAction) {
                        c.classList.add('gto-match'); // æ­£ç¡®
                    }
                }
            });
            updateRangePercentage(); // æ¸²æŸ“ç½‘æ ¼æ—¶æ›´æ–°ç™¾åˆ†æ¯”
        }

        // è®¡ç®—æ‰‹ç‰ŒèŒƒå›´ç™¾åˆ†æ¯”
        function calculateRangePercentage() {
            const totalHands = 169; // æ€»æ‰‹ç‰Œæ•°
            const selectedHands = Object.keys(userGridData).filter(hand => userGridData[hand] !== 'fold').length;
            return ((selectedHands / totalHands) * 100).toFixed(1);
        }

        // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
        function updateRangePercentage() {
            const percentage = calculateRangePercentage();
            const selectedHands = Object.keys(userGridData).filter(hand => userGridData[hand] !== 'fold').length;
            
            const percentageElement = document.getElementById('rangePercentage');
            const countElement = document.getElementById('selectedHandsCount');
            const progressBar = document.getElementById('rangeProgressBar');
            
            if (percentageElement) {
                percentageElement.textContent = `${percentage}%`;
            }
            if (countElement) {
                countElement.textContent = selectedHands;
            }
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
        }

        function clearGrid() {
            userGridData = {};
            renderGrid();
            updateRangePercentage(); // æ¸…ç©ºæ—¶æ›´æ–°ç™¾åˆ†æ¯”
        }

        // === å­˜å‚¨é€»è¾‘ ===
        
        function getKey() {
            const mode = document.getElementById('modeSelect').value;
            const size = document.getElementById('tableSizeSelect').value;
            const pos = document.getElementById('positionSelect').value;
            const stack = document.getElementById('stackSelect').value;
            const action = document.getElementById('actionSelect').value;
            return `GTO|${mode}|${size}|${pos}|${stack}|${action}`;
        }

        function saveCurrent() {
            const key = getKey();
            localStorage.setItem(key, JSON.stringify(userGridData));
            const pos = document.getElementById('positionSelect').value;
            const stack = document.getElementById('stackSelect').value;
            const action = document.getElementById('actionSelect').value;
            showMsg(`âœ… å·²ä¿å­˜: ${pos} ${stack} ${action}`);
            loadSavedList(); // åˆ·æ–°åˆ—è¡¨
        }

        function loadSavedList() {
            const list = document.getElementById('recordList');
            list.innerHTML = '';
            
            // éå† LocalStorage æŸ¥æ‰¾ä»¥ GTO| å¼€å¤´çš„ Key
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('GTO|')) {
                    const parts = key.split('|'); // [GTO, Mode, Size, Pos, Stack, Action]
                    const item = document.createElement('div');
                    item.className = 'record-item';
                    item.innerHTML = `
                        <div class="record-info">
                            <span style="font-weight:bold; color:#fff">${parts[3]} - ${parts[4]}</span>
                            <span class="record-date">${parts[1]} / ${parts[2]} / ${parts[5]}</span>
                        </div>
                        <div style="color:#aaa">â”</div>
                    `;
                    item.onclick = () => loadRecord(key, parts);
                    list.appendChild(item);
                }
            }
        }

        function loadRecord(key, parts) {
            // 1. è®¾ç½®ä¸‹æ‹‰æ¡†
            setSelect('modeSelect', parts[1]);
            setSelect('tableSizeSelect', parts[2]);
            updateOptions(); // åˆ·æ–°ä¾èµ–é¡¹
            setTimeout(() => {
                setSelect('positionSelect', parts[3]);
                setSelect('stackSelect', parts[4]);
                setSelect('actionSelect', parts[5]);
                
                // 2. åŠ è½½æ•°æ®
                const data = JSON.parse(localStorage.getItem(key));
                userGridData = data;
                renderGrid();
                updateRangePercentage(); // åŠ è½½æ•°æ®æ—¶æ›´æ–°ç™¾åˆ†æ¯”
                
                showMsg("ğŸ“‚ æ¡£æ¡ˆåŠ è½½æˆåŠŸ");
                toggleLibrary(); // å…³é—­ä¾§è¾¹æ 
            }, 50);
        }

        function setSelect(id, val) {
            const sel = document.getElementById(id);
            if(sel) sel.value = val;
        }

        function toggleLibrary() {
            const panel = document.getElementById('libraryPanel');
            panel.classList.toggle('open');
            if(panel.classList.contains('open')) loadSavedList();
        }
        
        function clearAllData() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¿å­˜çš„ GTO æ¡£æ¡ˆå—ï¼Ÿ")) {
                Object.keys(localStorage).forEach(k => {
                    if(k.startsWith('GTO|')) localStorage.removeItem(k);
                });
                loadSavedList();
                showMsg("å·²æ¸…ç©ºåº“");
            }
        }

        function showMsg(text) {
            const box = document.getElementById('msgBox');
            box.innerText = text;
            box.style.opacity = 1;
            setTimeout(() => box.style.opacity = 0, 2000);
        }

        // === å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ ===
        
        function exportData() {
            // æ”¶é›†æ‰€æœ‰GTOæ•°æ®
            const exportData = {};
            const metadata = {
                exportDate: new Date().toISOString(),
                version: "1.0",
                totalRecords: 0
            };
            
            // éå†localStorageä¸­çš„æ‰€æœ‰GTOæ•°æ®
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('GTO|')) {
                    try {
                        const value = localStorage.getItem(key);
                        exportData[key] = JSON.parse(value);
                        metadata.totalRecords++;
                    } catch(e) {
                        console.warn(`è·³è¿‡æŸåçš„æ•°æ®: ${key}`);
                    }
                }
            }
            
            if(metadata.totalRecords === 0) {
                showMsg("âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®");
                return;
            }
            
            // åˆ›å»ºå®Œæ•´çš„å¯¼å‡ºå¯¹è±¡
            const fullExport = {
                metadata: metadata,
                data: exportData
            };
            
            // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            const jsonString = JSON.stringify(fullExport, null, 2);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GTOé…ç½®_${new Date().toISOString().slice(0, 10)}_${metadata.totalRecords}æ¡.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMsg(`âœ… æˆåŠŸå¯¼å‡º ${metadata.totalRecords} æ¡é…ç½®`);
        }
        
        function importData() {
            // è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            if(!file.name.endsWith('.json')) {
                showMsg("âŒ è¯·é€‰æ‹©JSONæ–‡ä»¶");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if(!importData.data || typeof importData.data !== 'object') {
                        throw new Error("æ— æ•ˆçš„æ•°æ®æ ¼å¼");
                    }
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    // å¯¼å…¥æ•°æ®
                    Object.keys(importData.data).forEach(key => {
                        if(key.startsWith('GTO|')) {
                            try {
                                const value = JSON.stringify(importData.data[key]);
                                localStorage.setItem(key, value);
                                importedCount++;
                            } catch(e) {
                                console.warn(`å¯¼å…¥å¤±è´¥: ${key}`, e);
                                skippedCount++;
                            }
                        }
                    });
                    
                    // åˆ·æ–°æ¡£æ¡ˆåº“åˆ—è¡¨
                    loadSavedList();
                    
                    const msg = `âœ… å¯¼å…¥æˆåŠŸ: ${importedCount}æ¡`;
                    if(skippedCount > 0) {
                        showMsg(`${msg}, è·³è¿‡: ${skippedCount}æ¡`);
                    } else {
                        showMsg(msg);
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
                    event.target.value = '';
                    
                } catch(error) {
                    showMsg("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æ•°æ®æŸå");
                    console.error("å¯¼å…¥é”™è¯¯:", error);
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                showMsg("âŒ æ–‡ä»¶è¯»å–å¤±è´¥");
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>